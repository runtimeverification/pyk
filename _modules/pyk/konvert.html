<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyk.konvert &#8212; pyk 0.1.619 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=302214b3"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyk.konvert</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="linenos">   2</span>
<span class="linenos">   3</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="linenos">   4</span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="linenos">   5</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="linenos">   6</span>
<span class="linenos">   7</span><span class="kn">from</span> <span class="nn">.cterm</span> <span class="kn">import</span> <span class="n">CTerm</span>
<span class="linenos">   8</span><span class="kn">from</span> <span class="nn">.kast</span> <span class="kn">import</span> <span class="n">EMPTY_ATT</span><span class="p">,</span> <span class="n">KAtt</span><span class="p">,</span> <span class="n">KInner</span>
<span class="linenos">   9</span><span class="kn">from</span> <span class="nn">.kast.inner</span> <span class="kn">import</span> <span class="n">KApply</span><span class="p">,</span> <span class="n">KLabel</span><span class="p">,</span> <span class="n">KRewrite</span><span class="p">,</span> <span class="n">KSequence</span><span class="p">,</span> <span class="n">KSort</span><span class="p">,</span> <span class="n">KToken</span><span class="p">,</span> <span class="n">KVariable</span>
<span class="linenos">  10</span><span class="kn">from</span> <span class="nn">.kast.manip</span> <span class="kn">import</span> <span class="n">bool_to_ml_pred</span><span class="p">,</span> <span class="n">extract_lhs</span><span class="p">,</span> <span class="n">extract_rhs</span>
<span class="linenos">  11</span><span class="kn">from</span> <span class="nn">.kast.outer</span> <span class="kn">import</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">,</span> <span class="n">KRule</span><span class="p">,</span> <span class="n">KSyntaxSort</span>
<span class="linenos">  12</span><span class="kn">from</span> <span class="nn">.kore.prelude</span> <span class="kn">import</span> <span class="n">BYTES</span> <span class="k">as</span> <span class="n">KORE_BYTES</span>
<span class="linenos">  13</span><span class="kn">from</span> <span class="nn">.kore.prelude</span> <span class="kn">import</span> <span class="n">DOTK</span><span class="p">,</span> <span class="n">SORT_K</span>
<span class="linenos">  14</span><span class="kn">from</span> <span class="nn">.kore.prelude</span> <span class="kn">import</span> <span class="n">STRING</span> <span class="k">as</span> <span class="n">KORE_STRING</span>
<span class="linenos">  15</span><span class="kn">from</span> <span class="nn">.kore.syntax</span> <span class="kn">import</span> <span class="p">(</span>
<span class="linenos">  16</span>    <span class="n">DV</span><span class="p">,</span>
<span class="linenos">  17</span>    <span class="n">And</span><span class="p">,</span>
<span class="linenos">  18</span>    <span class="n">App</span><span class="p">,</span>
<span class="linenos">  19</span>    <span class="n">Assoc</span><span class="p">,</span>
<span class="linenos">  20</span>    <span class="n">Axiom</span><span class="p">,</span>
<span class="linenos">  21</span>    <span class="n">Bottom</span><span class="p">,</span>
<span class="linenos">  22</span>    <span class="n">Ceil</span><span class="p">,</span>
<span class="linenos">  23</span>    <span class="n">Equals</span><span class="p">,</span>
<span class="linenos">  24</span>    <span class="n">EVar</span><span class="p">,</span>
<span class="linenos">  25</span>    <span class="n">Exists</span><span class="p">,</span>
<span class="linenos">  26</span>    <span class="n">Implies</span><span class="p">,</span>
<span class="linenos">  27</span>    <span class="n">Import</span><span class="p">,</span>
<span class="linenos">  28</span>    <span class="n">MLPattern</span><span class="p">,</span>
<span class="linenos">  29</span>    <span class="n">MLQuant</span><span class="p">,</span>
<span class="linenos">  30</span>    <span class="n">Module</span><span class="p">,</span>
<span class="linenos">  31</span>    <span class="n">Not</span><span class="p">,</span>
<span class="linenos">  32</span>    <span class="n">Rewrites</span><span class="p">,</span>
<span class="linenos">  33</span>    <span class="n">SortApp</span><span class="p">,</span>
<span class="linenos">  34</span>    <span class="n">SortDecl</span><span class="p">,</span>
<span class="linenos">  35</span>    <span class="n">SortVar</span><span class="p">,</span>
<span class="linenos">  36</span>    <span class="n">String</span><span class="p">,</span>
<span class="linenos">  37</span>    <span class="n">Symbol</span><span class="p">,</span>
<span class="linenos">  38</span>    <span class="n">SymbolDecl</span><span class="p">,</span>
<span class="linenos">  39</span>    <span class="n">Top</span><span class="p">,</span>
<span class="linenos">  40</span><span class="p">)</span>
<span class="linenos">  41</span><span class="kn">from</span> <span class="nn">.prelude.bytes</span> <span class="kn">import</span> <span class="n">BYTES</span><span class="p">,</span> <span class="n">bytesToken_from_str</span><span class="p">,</span> <span class="n">pretty_bytes_str</span>
<span class="linenos">  42</span><span class="kn">from</span> <span class="nn">.prelude.k</span> <span class="kn">import</span> <span class="n">K_ITEM</span><span class="p">,</span> <span class="n">K</span>
<span class="linenos">  43</span><span class="kn">from</span> <span class="nn">.prelude.ml</span> <span class="kn">import</span> <span class="n">mlAnd</span><span class="p">,</span> <span class="n">mlBottom</span><span class="p">,</span> <span class="n">mlCeil</span><span class="p">,</span> <span class="n">mlEquals</span><span class="p">,</span> <span class="n">mlExists</span><span class="p">,</span> <span class="n">mlImplies</span><span class="p">,</span> <span class="n">mlNot</span><span class="p">,</span> <span class="n">mlTop</span>
<span class="linenos">  44</span><span class="kn">from</span> <span class="nn">.prelude.string</span> <span class="kn">import</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">pretty_string</span><span class="p">,</span> <span class="n">stringToken</span>
<span class="linenos">  45</span><span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">FrozenDict</span>
<span class="linenos">  46</span>
<span class="linenos">  47</span><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
<span class="linenos">  48</span>    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="linenos">  49</span>    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Final</span>
<span class="linenos">  50</span>
<span class="linenos">  51</span>    <span class="kn">from</span> <span class="nn">.kast.outer</span> <span class="kn">import</span> <span class="n">KFlatModule</span><span class="p">,</span> <span class="n">KImport</span><span class="p">,</span> <span class="n">KSentence</span>
<span class="linenos">  52</span>    <span class="kn">from</span> <span class="nn">.kore.kompiled</span> <span class="kn">import</span> <span class="n">KompiledKore</span>
<span class="linenos">  53</span>    <span class="kn">from</span> <span class="nn">.kore.syntax</span> <span class="kn">import</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">Sentence</span><span class="p">,</span> <span class="n">Sort</span>
<span class="linenos">  54</span>
<span class="linenos">  55</span><span class="n">_LOGGER</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos">  56</span>
<span class="linenos">  57</span>
<span class="linenos">  58</span><span class="c1"># --------------</span>
<span class="linenos">  59</span><span class="c1"># Module to KORE</span>
<span class="linenos">  60</span><span class="c1"># --------------</span>
<span class="linenos">  61</span>
<span class="linenos">  62</span>
<span class="linenos">  63</span><span class="n">KORE_KEYWORDS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  64</span>    <span class="s1">&#39;alias&#39;</span><span class="p">,</span>
<span class="linenos">  65</span>    <span class="s1">&#39;axiom&#39;</span><span class="p">,</span>
<span class="linenos">  66</span>    <span class="s1">&#39;endmodule&#39;</span><span class="p">,</span>
<span class="linenos">  67</span>    <span class="s1">&#39;hooked-sort&#39;</span><span class="p">,</span>
<span class="linenos">  68</span>    <span class="s1">&#39;hooked-symbol&#39;</span><span class="p">,</span>
<span class="linenos">  69</span>    <span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="linenos">  70</span>    <span class="s1">&#39;sort&#39;</span><span class="p">,</span>
<span class="linenos">  71</span>    <span class="s1">&#39;symbol&#39;</span><span class="p">,</span>
<span class="linenos">  72</span><span class="p">}</span>
<span class="linenos">  73</span>
<span class="linenos">  74</span>
<span class="linenos">  75</span><span class="n">BUILTIN_LABELS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  76</span>    <span class="s1">&#39;#Bottom&#39;</span><span class="p">,</span>
<span class="linenos">  77</span>    <span class="s1">&#39;#Top&#39;</span><span class="p">,</span>
<span class="linenos">  78</span>    <span class="s1">&#39;#Not&#39;</span><span class="p">,</span>
<span class="linenos">  79</span>    <span class="s1">&#39;#Or&#39;</span><span class="p">,</span>
<span class="linenos">  80</span>    <span class="s1">&#39;#And&#39;</span><span class="p">,</span>
<span class="linenos">  81</span>    <span class="s1">&#39;#Implies&#39;</span><span class="p">,</span>
<span class="linenos">  82</span>    <span class="s1">&#39;#Equals&#39;</span><span class="p">,</span>
<span class="linenos">  83</span>    <span class="s1">&#39;#Ceil&#39;</span><span class="p">,</span>
<span class="linenos">  84</span>    <span class="s1">&#39;#Floor&#39;</span><span class="p">,</span>
<span class="linenos">  85</span>    <span class="s1">&#39;#Exists&#39;</span><span class="p">,</span>
<span class="linenos">  86</span>    <span class="s1">&#39;#Forall&#39;</span><span class="p">,</span>
<span class="linenos">  87</span>    <span class="s1">&#39;#AG&#39;</span><span class="p">,</span>
<span class="linenos">  88</span>    <span class="s1">&#39;weakExistsFinally&#39;</span><span class="p">,</span>
<span class="linenos">  89</span>    <span class="s1">&#39;weakAlwaysFinally&#39;</span><span class="p">,</span>
<span class="linenos">  90</span><span class="p">}</span>
<span class="linenos">  91</span>
<span class="linenos">  92</span>
<div class="viewcode-block" id="module_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.module_to_kore">[docs]</a>
<span class="linenos">  93</span><span class="k">def</span> <span class="nf">module_to_kore</span><span class="p">(</span><span class="n">definition</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos">  94</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert the main module of a kompiled KAST definition to KORE format.&quot;&quot;&quot;</span>
<span class="linenos">  95</span>
<span class="linenos">  96</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">simplified_module</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
<span class="linenos">  97</span>
<span class="linenos">  98</span>    <span class="n">name</span> <span class="o">=</span> <span class="n">name_to_kore</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">  99</span>    <span class="n">attrs</span> <span class="o">=</span> <span class="n">atts_to_kore</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;digest&#39;</span><span class="p">})</span>  <span class="c1"># filter digest</span>
<span class="linenos"> 100</span>
<span class="linenos"> 101</span>    <span class="n">imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">Import</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)]</span>
<span class="linenos"> 102</span>    <span class="n">sort_decls</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 103</span>        <span class="n">sort_decl_to_kore</span><span class="p">(</span><span class="n">syntax_sort</span><span class="p">)</span>
<span class="linenos"> 104</span>        <span class="k">for</span> <span class="n">syntax_sort</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">syntax_sorts</span>
<span class="linenos"> 105</span>        <span class="k">if</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">K</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">K_ITEM</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
<span class="linenos"> 106</span>    <span class="p">]</span>
<span class="linenos"> 107</span>    <span class="n">symbol_decls</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 108</span>        <span class="n">symbol_prod_to_kore</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
<span class="linenos"> 109</span>        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">sentences</span>
<span class="linenos"> 110</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span> <span class="ow">and</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BUILTIN_LABELS</span>
<span class="linenos"> 111</span>    <span class="p">]</span>
<span class="linenos"> 112</span>
<span class="linenos"> 113</span>    <span class="n">sentences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Sentence</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 114</span>    <span class="n">sentences</span> <span class="o">+=</span> <span class="n">imports</span>
<span class="linenos"> 115</span>    <span class="n">sentences</span> <span class="o">+=</span> <span class="n">sort_decls</span>
<span class="linenos"> 116</span>    <span class="n">sentences</span> <span class="o">+=</span> <span class="n">symbol_decls</span>
<span class="linenos"> 117</span>
<span class="linenos"> 118</span>    <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span></div>

<span class="linenos"> 119</span>
<span class="linenos"> 120</span>
<span class="linenos"> 121</span><span class="c1"># TODO should this be used in _klabel_to_kore?</span>
<div class="viewcode-block" id="name_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.name_to_kore">[docs]</a>
<span class="linenos"> 122</span><span class="k">def</span> <span class="nf">name_to_kore</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 123</span>    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">KORE_KEYWORDS</span><span class="p">:</span>
<span class="linenos"> 124</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;Kywd&#39;&quot;</span>
<span class="linenos"> 125</span>    <span class="k">return</span> <span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<span class="linenos"> 126</span>
<span class="linenos"> 127</span>
<div class="viewcode-block" id="atts_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.atts_to_kore">[docs]</a>
<span class="linenos"> 128</span><span class="k">def</span> <span class="nf">atts_to_kore</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">App</span><span class="p">]:</span>
<span class="linenos"> 129</span>    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">att_to_kore</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">att</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos"> 130</span>    <span class="n">res</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">app</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
<span class="linenos"> 131</span>    <span class="k">return</span> <span class="n">res</span></div>

<span class="linenos"> 132</span>
<span class="linenos"> 133</span>
<div class="viewcode-block" id="att_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.att_to_kore">[docs]</a>
<span class="linenos"> 134</span><span class="k">def</span> <span class="nf">att_to_kore</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">App</span><span class="p">:</span>
<span class="linenos"> 135</span>    <span class="n">symbol</span> <span class="o">=</span> <span class="n">name_to_kore</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="linenos"> 136</span>
<span class="linenos"> 137</span>    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
<span class="linenos"> 138</span>        <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="linenos"> 139</span>
<span class="linenos"> 140</span>    <span class="n">parse_res</span> <span class="o">=</span> <span class="n">_parse_special_att_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 141</span>    <span class="k">if</span> <span class="n">parse_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 142</span>        <span class="n">sorts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parse_res</span>
<span class="linenos"> 143</span>        <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="linenos"> 144</span>
<span class="linenos"> 145</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 146</span>        <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">value</span><span class="p">),))</span>
<span class="linenos"> 147</span>
<span class="linenos"> 148</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">FrozenDict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;node&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<span class="linenos"> 149</span>        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;KSort&#39;</span><span class="p">:</span>
<span class="linenos"> 150</span>            <span class="n">sort_name</span> <span class="o">=</span> <span class="n">name_to_kore</span><span class="p">(</span><span class="n">KSort</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># &#39;Sort&#39; is not prepended by ModuleToKORE</span>
<span class="linenos"> 151</span>            <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">sort_name</span><span class="p">),))</span>
<span class="linenos"> 152</span>
<span class="linenos"> 153</span>        <span class="c1"># TODO Should be kast_to_kore, but we do not have a KompiledKore.</span>
<span class="linenos"> 154</span>        <span class="c1"># TODO We should be able to add injections based on info in KDefinition.</span>
<span class="linenos"> 155</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">_kast_to_kore</span><span class="p">(</span><span class="n">KInner</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="linenos"> 156</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">App</span><span class="p">):</span>
<span class="linenos"> 157</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected application as attribure, got: </span><span class="si">{pattern.text}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 158</span>        <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,))</span>
<span class="linenos"> 159</span>
<span class="linenos"> 160</span>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attribute conversion is not implemented for: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="linenos"> 161</span>
<span class="linenos"> 162</span>
<span class="linenos"> 163</span><span class="k">def</span> <span class="nf">_parse_special_att_value</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 164</span>    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">:</span>
<span class="linenos"> 165</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
<span class="linenos"> 166</span>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
<span class="linenos"> 167</span>        <span class="n">loc_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 168</span>        <span class="k">return</span> <span class="p">(),</span> <span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location(</span><span class="si">{</span><span class="n">loc_str</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">),)</span>
<span class="linenos"> 169</span>    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">:</span>
<span class="linenos"> 170</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="linenos"> 171</span>        <span class="k">return</span> <span class="p">(),</span> <span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Source(</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">),)</span>
<span class="linenos"> 172</span>    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">ELEMENT</span><span class="p">:</span>
<span class="linenos"> 173</span>        <span class="c1"># TODO avoid special casing by pre-processing the attribute into a KApply</span>
<span class="linenos"> 174</span>        <span class="c1"># This should be handled by the frontend</span>
<span class="linenos"> 175</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="linenos"> 176</span>        <span class="k">return</span> <span class="p">(),</span> <span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="n">_label_name</span><span class="p">(</span><span class="n">value</span><span class="p">)),)</span>
<span class="linenos"> 177</span>    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span><span class="p">:</span>  <span class="c1"># TODO same here</span>
<span class="linenos"> 178</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="linenos"> 179</span>        <span class="k">return</span> <span class="p">(),</span> <span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="n">_label_name</span><span class="p">(</span><span class="n">value</span><span class="p">)),)</span>
<span class="linenos"> 180</span>    <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 181</span>
<span class="linenos"> 182</span>
<div class="viewcode-block" id="sort_decl_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.sort_decl_to_kore">[docs]</a>
<span class="linenos"> 183</span><span class="k">def</span> <span class="nf">sort_decl_to_kore</span><span class="p">(</span><span class="n">syntax_sort</span><span class="p">:</span> <span class="n">KSyntaxSort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SortDecl</span><span class="p">:</span>
<span class="linenos"> 184</span>    <span class="n">name</span> <span class="o">=</span> <span class="n">_sort_name</span><span class="p">(</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 185</span>    <span class="n">attrs</span> <span class="o">=</span> <span class="n">atts_to_kore</span><span class="p">(</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="p">)</span>
<span class="linenos"> 186</span>    <span class="n">hooked</span> <span class="o">=</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span> <span class="ow">in</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span>
<span class="linenos"> 187</span>    <span class="k">return</span> <span class="n">SortDecl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">hooked</span><span class="o">=</span><span class="n">hooked</span><span class="p">)</span></div>

<span class="linenos"> 188</span>
<span class="linenos"> 189</span>
<div class="viewcode-block" id="sort_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.sort_to_kore">[docs]</a>
<span class="linenos"> 190</span><span class="k">def</span> <span class="nf">sort_to_kore</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="n">KSort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SortApp</span><span class="p">:</span>
<span class="linenos"> 191</span>    <span class="k">return</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">_sort_name</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<span class="linenos"> 192</span>
<span class="linenos"> 193</span>
<span class="linenos"> 194</span><span class="k">def</span> <span class="nf">_sort_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 195</span>    <span class="k">return</span> <span class="s1">&#39;Sort&#39;</span> <span class="o">+</span> <span class="n">name_to_kore</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 196</span>
<span class="linenos"> 197</span>
<span class="linenos"> 198</span><span class="k">def</span> <span class="nf">_label_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 199</span>    <span class="k">return</span> <span class="s1">&#39;Lbl&#39;</span> <span class="o">+</span> <span class="n">name_to_kore</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span>
<div class="viewcode-block" id="symbol_prod_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.symbol_prod_to_kore">[docs]</a>
<span class="linenos"> 202</span><span class="k">def</span> <span class="nf">symbol_prod_to_kore</span><span class="p">(</span><span class="n">production</span><span class="p">:</span> <span class="n">KProduction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymbolDecl</span><span class="p">:</span>
<span class="linenos"> 203</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">production</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 204</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected symbol production, got: </span><span class="si">{</span><span class="n">production</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 205</span>
<span class="linenos"> 206</span>    <span class="n">symbol_name</span> <span class="o">=</span> <span class="n">_label_name</span><span class="p">(</span><span class="n">production</span><span class="o">.</span><span class="n">klabel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 207</span>    <span class="n">symbol_vars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">SortVar</span><span class="p">(</span><span class="n">_sort_name</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="linenos"> 208</span>    <span class="n">symbol</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">symbol_name</span><span class="p">,</span> <span class="n">symbol_vars</span><span class="p">)</span>
<span class="linenos"> 209</span>
<span class="linenos"> 210</span>    <span class="k">def</span> <span class="nf">to_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="n">KSort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sort</span><span class="p">:</span>
<span class="linenos"> 211</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">_sort_name</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 212</span>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
<span class="linenos"> 213</span>            <span class="k">return</span> <span class="n">SortVar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 214</span>        <span class="k">return</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 215</span>
<span class="linenos"> 216</span>    <span class="n">param_sorts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">to_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">argument_sorts</span><span class="p">)</span>
<span class="linenos"> 217</span>    <span class="n">sort</span> <span class="o">=</span> <span class="n">to_sort</span><span class="p">(</span><span class="n">production</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 218</span>    <span class="n">attrs</span> <span class="o">=</span> <span class="n">atts_to_kore</span><span class="p">(</span><span class="n">production</span><span class="o">.</span><span class="n">att</span><span class="p">)</span>
<span class="linenos"> 219</span>    <span class="n">hooked</span> <span class="o">=</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">att</span>
<span class="linenos"> 220</span>    <span class="k">return</span> <span class="n">SymbolDecl</span><span class="p">(</span>
<span class="linenos"> 221</span>        <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
<span class="linenos"> 222</span>        <span class="n">param_sorts</span><span class="o">=</span><span class="n">param_sorts</span><span class="p">,</span>
<span class="linenos"> 223</span>        <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
<span class="linenos"> 224</span>        <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span>
<span class="linenos"> 225</span>        <span class="n">hooked</span><span class="o">=</span><span class="n">hooked</span><span class="p">,</span>
<span class="linenos"> 226</span>    <span class="p">)</span></div>

<span class="linenos"> 227</span>
<span class="linenos"> 228</span>
<span class="linenos"> 229</span><span class="c1"># ----------------------------------</span>
<span class="linenos"> 230</span><span class="c1"># Module to KORE: KAST preprocessing</span>
<span class="linenos"> 231</span><span class="c1"># ----------------------------------</span>
<span class="linenos"> 232</span>
<span class="linenos"> 233</span>
<span class="linenos"> 234</span><span class="n">HOOK_NAMESPACES</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 235</span>    <span class="s1">&#39;ARRAY&#39;</span><span class="p">,</span>
<span class="linenos"> 236</span>    <span class="s1">&#39;BOOL&#39;</span><span class="p">,</span>
<span class="linenos"> 237</span>    <span class="s1">&#39;BUFFER&#39;</span><span class="p">,</span>
<span class="linenos"> 238</span>    <span class="s1">&#39;BYTES&#39;</span><span class="p">,</span>
<span class="linenos"> 239</span>    <span class="s1">&#39;FFI&#39;</span><span class="p">,</span>
<span class="linenos"> 240</span>    <span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span>
<span class="linenos"> 241</span>    <span class="s1">&#39;INT&#39;</span><span class="p">,</span>
<span class="linenos"> 242</span>    <span class="s1">&#39;IO&#39;</span><span class="p">,</span>
<span class="linenos"> 243</span>    <span class="s1">&#39;JSON&#39;</span><span class="p">,</span>
<span class="linenos"> 244</span>    <span class="s1">&#39;KEQUAL&#39;</span><span class="p">,</span>
<span class="linenos"> 245</span>    <span class="s1">&#39;KREFLECTION&#39;</span><span class="p">,</span>
<span class="linenos"> 246</span>    <span class="s1">&#39;LIST&#39;</span><span class="p">,</span>
<span class="linenos"> 247</span>    <span class="s1">&#39;MAP&#39;</span><span class="p">,</span>
<span class="linenos"> 248</span>    <span class="s1">&#39;MINT&#39;</span><span class="p">,</span>
<span class="linenos"> 249</span>    <span class="s1">&#39;RANGEMAP&#39;</span><span class="p">,</span>
<span class="linenos"> 250</span>    <span class="s1">&#39;SET&#39;</span><span class="p">,</span>
<span class="linenos"> 251</span>    <span class="s1">&#39;STRING&#39;</span><span class="p">,</span>
<span class="linenos"> 252</span>    <span class="s1">&#39;SUBSTITUTION&#39;</span><span class="p">,</span>
<span class="linenos"> 253</span>    <span class="s1">&#39;UNIFICATION&#39;</span><span class="p">,</span>
<span class="linenos"> 254</span><span class="p">}</span>
<span class="linenos"> 255</span>
<span class="linenos"> 256</span>
<span class="linenos"> 257</span><span class="n">COLLECTION_HOOKS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 258</span>    <span class="s1">&#39;SET.Set&#39;</span><span class="p">,</span>
<span class="linenos"> 259</span>    <span class="s1">&#39;MAP.Map&#39;</span><span class="p">,</span>
<span class="linenos"> 260</span>    <span class="s1">&#39;LIST.List&#39;</span><span class="p">,</span>
<span class="linenos"> 261</span>    <span class="s1">&#39;ARRAY.Array&#39;</span><span class="p">,</span>
<span class="linenos"> 262</span>    <span class="s1">&#39;RANGEMAP.RangeMap&#39;</span><span class="p">,</span>
<span class="linenos"> 263</span><span class="p">}</span>
<span class="linenos"> 264</span>
<span class="linenos"> 265</span>
<div class="viewcode-block" id="simplified_module">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.simplified_module">[docs]</a>
<span class="linenos"> 266</span><span class="k">def</span> <span class="nf">simplified_module</span><span class="p">(</span><span class="n">definition</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 267</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 268</span><span class="sd">    In ModuleToKORE.java, there are some implicit KAST-to-KAST kompilation</span>
<span class="linenos"> 269</span><span class="sd">    steps hidden in the conversion. In particular, the kompiled KAST definition</span>
<span class="linenos"> 270</span><span class="sd">    (compiled.json) is modular, whereas the kompiled definition</span>
<span class="linenos"> 271</span><span class="sd">    (definition.kore) is flat.</span>
<span class="linenos"> 272</span>
<span class="linenos"> 273</span><span class="sd">    This function aims to factor out these hidden KAST-to-KAST kompilation</span>
<span class="linenos"> 274</span><span class="sd">    steps so that our implementation of module_to_kore can be as simple as</span>
<span class="linenos"> 275</span><span class="sd">    possible. Moreover, this has the potential to shed some light on how</span>
<span class="linenos"> 276</span><span class="sd">    modules can be kompiled incrementally.</span>
<span class="linenos"> 277</span>
<span class="linenos"> 278</span><span class="sd">    This function is an approximation, i.e. there might be cases where it</span>
<span class="linenos"> 279</span><span class="sd">    produces a different result to what would be expected based on kompile&#39;s</span>
<span class="linenos"> 280</span><span class="sd">    output. These discrepancies should be analyzed and fixed.</span>
<span class="linenos"> 281</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 282</span>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span> <span class="ow">or</span> <span class="n">definition</span><span class="o">.</span><span class="n">main_module_name</span>
<span class="linenos"> 283</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_flatten_module</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>  <span class="c1"># TODO KORE supports imports, why is definition.kore flat?</span>
<span class="linenos"> 284</span>
<span class="linenos"> 285</span>    <span class="c1"># sorts</span>
<span class="linenos"> 286</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_syntax_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 287</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_collection_atts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 288</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_domain_value_atts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 289</span>
<span class="linenos"> 290</span>    <span class="c1"># symbols</span>
<span class="linenos"> 291</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_pull_up_rewrites</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 292</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_discard_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">])</span>
<span class="linenos"> 293</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_discard_hook_atts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 294</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_anywhere_atts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 295</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span> <span class="n">_is_macro</span><span class="p">)</span>
<span class="linenos"> 296</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">,</span> <span class="n">_is_functional</span><span class="p">)</span>
<span class="linenos"> 297</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">INJECTIVE</span><span class="p">,</span> <span class="n">_is_injective</span><span class="p">)</span>
<span class="linenos"> 298</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">_add_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">CONSTRUCTOR</span><span class="p">,</span> <span class="n">_is_constructor</span><span class="p">)</span>
<span class="linenos"> 299</span>
<span class="linenos"> 300</span>    <span class="k">return</span> <span class="n">module</span></div>

<span class="linenos"> 301</span>
<span class="linenos"> 302</span>
<span class="linenos"> 303</span><span class="k">def</span> <span class="nf">_flatten_module</span><span class="p">(</span><span class="n">definition</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 304</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a flat module with all sentences included and without imports&quot;&quot;&quot;</span>
<span class="linenos"> 305</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
<span class="linenos"> 306</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="n">_imported_sentences</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
<span class="linenos"> 307</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">,</span> <span class="n">imports</span><span class="o">=</span><span class="p">())</span>
<span class="linenos"> 308</span>
<span class="linenos"> 309</span>
<span class="linenos"> 310</span><span class="k">def</span> <span class="nf">_imported_sentences</span><span class="p">(</span><span class="n">definition</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">KSentence</span><span class="p">]:</span>
<span class="linenos"> 311</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all sentences from imported modules, including the module itself.&quot;&quot;&quot;</span>
<span class="linenos"> 312</span>
<span class="linenos"> 313</span>    <span class="n">pending</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
<span class="linenos"> 314</span>    <span class="n">imported</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 315</span>
<span class="linenos"> 316</span>    <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">KSentence</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 317</span>    <span class="k">while</span> <span class="n">pending</span><span class="p">:</span>
<span class="linenos"> 318</span>        <span class="n">module_name</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 319</span>        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">imported</span><span class="p">:</span>
<span class="linenos"> 320</span>            <span class="k">continue</span>
<span class="linenos"> 321</span>        <span class="n">module</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
<span class="linenos"> 322</span>        <span class="n">res</span> <span class="o">+=</span> <span class="n">module</span><span class="o">.</span><span class="n">sentences</span>
<span class="linenos"> 323</span>        <span class="n">pending</span> <span class="o">+=</span> <span class="p">(</span><span class="n">importt</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">importt</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">imports</span><span class="p">)</span>
<span class="linenos"> 324</span>        <span class="n">imported</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
<span class="linenos"> 325</span>
<span class="linenos"> 326</span>    <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 327</span>
<span class="linenos"> 328</span>
<span class="linenos"> 329</span><span class="k">def</span> <span class="nf">_add_syntax_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 330</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a module with explicit syntax declarations: each sort is declared with the union of its attributes.&quot;&quot;&quot;</span>
<span class="linenos"> 331</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentence</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">module</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KSyntaxSort</span><span class="p">)]</span>
<span class="linenos"> 332</span>    <span class="n">sentences</span> <span class="o">+=</span> <span class="n">_syntax_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 333</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 334</span>
<span class="linenos"> 335</span>
<span class="linenos"> 336</span><span class="k">def</span> <span class="nf">_syntax_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">KSyntaxSort</span><span class="p">]:</span>
<span class="linenos"> 337</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a declaration for each sort in the module.&quot;&quot;&quot;</span>
<span class="linenos"> 338</span>    <span class="n">declarations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">KSort</span><span class="p">,</span> <span class="n">KAtt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 339</span>
<span class="linenos"> 340</span>    <span class="k">def</span> <span class="nf">is_higher_order</span><span class="p">(</span><span class="n">production</span><span class="p">:</span> <span class="n">KProduction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 341</span>        <span class="c1"># Example: syntax {Sort} Sort ::= Sort &quot;#as&quot; Sort</span>
<span class="linenos"> 342</span>        <span class="k">return</span> <span class="n">production</span><span class="o">.</span><span class="n">sort</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">params</span>
<span class="linenos"> 343</span>
<span class="linenos"> 344</span>    <span class="c1"># Merge attributes from KSyntaxSort instances</span>
<span class="linenos"> 345</span>    <span class="k">for</span> <span class="n">syntax_sort</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">syntax_sorts</span><span class="p">:</span>
<span class="linenos"> 346</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span>
<span class="linenos"> 347</span>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">declarations</span><span class="p">:</span>
<span class="linenos"> 348</span>            <span class="n">declarations</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span> <span class="o">=</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span>
<span class="linenos"> 349</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 350</span>            <span class="k">assert</span> <span class="n">declarations</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="p">)</span>
<span class="linenos"> 351</span>            <span class="n">declarations</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span> <span class="o">=</span> <span class="n">declarations</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="p">)</span>
<span class="linenos"> 352</span>
<span class="linenos"> 353</span>    <span class="c1"># Also consider production sorts</span>
<span class="linenos"> 354</span>    <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">productions</span><span class="p">:</span>
<span class="linenos"> 355</span>        <span class="k">if</span> <span class="n">is_higher_order</span><span class="p">(</span><span class="n">production</span><span class="p">):</span>
<span class="linenos"> 356</span>            <span class="k">continue</span>
<span class="linenos"> 357</span>
<span class="linenos"> 358</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">production</span><span class="o">.</span><span class="n">sort</span>
<span class="linenos"> 359</span>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">declarations</span><span class="p">:</span>
<span class="linenos"> 360</span>            <span class="n">declarations</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMPTY_ATT</span>
<span class="linenos"> 361</span>
<span class="linenos"> 362</span>    <span class="k">return</span> <span class="p">[</span><span class="n">KSyntaxSort</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">att</span><span class="o">=</span><span class="n">att</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span><span class="p">,</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">declarations</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos"> 363</span>
<span class="linenos"> 364</span>
<span class="linenos"> 365</span><span class="k">def</span> <span class="nf">_add_collection_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 366</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a module where concat, element and unit attributes are added to collection sort declarations.&quot;&quot;&quot;</span>
<span class="linenos"> 367</span>
<span class="linenos"> 368</span>    <span class="c1"># Example: syntax Map ::= Map Map [..., klabel(_Map_), element(_|-&gt;_), unit(.Map), ...]</span>
<span class="linenos"> 369</span>    <span class="n">concat_prods</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="o">.</span><span class="n">sort</span><span class="p">:</span> <span class="n">prod</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">productions</span> <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">ELEMENT</span> <span class="ow">in</span> <span class="n">prod</span><span class="o">.</span><span class="n">att</span><span class="p">}</span>
<span class="linenos"> 370</span>
<span class="linenos"> 371</span>    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
<span class="linenos"> 372</span>        <span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span> <span class="ow">in</span> <span class="n">prod</span><span class="o">.</span><span class="n">att</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">concat_prods</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos"> 373</span>    <span class="p">)</span>  <span class="c1"># TODO Could be saved with a different attribute structure: concat(Element, Unit)</span>
<span class="linenos"> 374</span>
<span class="linenos"> 375</span>    <span class="k">def</span> <span class="nf">update_att</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 376</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KSyntaxSort</span><span class="p">):</span>
<span class="linenos"> 377</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 378</span>
<span class="linenos"> 379</span>        <span class="n">syntax_sort</span><span class="p">:</span> <span class="n">KSyntaxSort</span> <span class="o">=</span> <span class="n">sentence</span>
<span class="linenos"> 380</span>
<span class="linenos"> 381</span>        <span class="k">if</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COLLECTION_HOOKS</span><span class="p">:</span>
<span class="linenos"> 382</span>            <span class="k">return</span> <span class="n">syntax_sort</span>
<span class="linenos"> 383</span>
<span class="linenos"> 384</span>        <span class="n">prod_att</span> <span class="o">=</span> <span class="n">concat_prods</span><span class="p">[</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span><span class="p">]</span><span class="o">.</span><span class="n">att</span>
<span class="linenos"> 385</span>
<span class="linenos"> 386</span>        <span class="k">return</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">let</span><span class="p">(</span>
<span class="linenos"> 387</span>            <span class="n">att</span><span class="o">=</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<span class="linenos"> 388</span>                <span class="p">{</span>
<span class="linenos"> 389</span>                    <span class="c1"># TODO Here, the attriubte is stored as dict, but ultimately we should parse known attributes in KAtt.from_dict</span>
<span class="linenos"> 390</span>                    <span class="n">KAtt</span><span class="o">.</span><span class="n">CONCAT</span><span class="p">:</span> <span class="n">KApply</span><span class="p">(</span><span class="n">prod_att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<span class="linenos"> 391</span>                    <span class="c1"># TODO Here, we keep the format from the frontend so that the attributes on SyntaxSort and Production are of the same type.</span>
<span class="linenos"> 392</span>                    <span class="n">KAtt</span><span class="o">.</span><span class="n">ELEMENT</span><span class="p">:</span> <span class="n">prod_att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">ELEMENT</span><span class="p">],</span>
<span class="linenos"> 393</span>                    <span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span><span class="p">:</span> <span class="n">prod_att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span><span class="p">],</span>
<span class="linenos"> 394</span>                <span class="p">}</span>
<span class="linenos"> 395</span>            <span class="p">)</span>
<span class="linenos"> 396</span>        <span class="p">)</span>
<span class="linenos"> 397</span>
<span class="linenos"> 398</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update_att</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 399</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 400</span>
<span class="linenos"> 401</span>
<span class="linenos"> 402</span><span class="k">def</span> <span class="nf">_add_domain_value_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 403</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a module where attribute &quot;hasDomainValues&quot; is added to all sort declarations that apply.</span>
<span class="linenos"> 404</span>
<span class="linenos"> 405</span><span class="sd">    The requirement on a sort declaration is to either have the &quot;token&quot; attribute directly</span>
<span class="linenos"> 406</span><span class="sd">    or on a corresponding production.</span>
<span class="linenos"> 407</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 408</span>
<span class="linenos"> 409</span>    <span class="n">token_sorts</span> <span class="o">=</span> <span class="n">_token_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 410</span>
<span class="linenos"> 411</span>    <span class="k">def</span> <span class="nf">update_att</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 412</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KSyntaxSort</span><span class="p">):</span>
<span class="linenos"> 413</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 414</span>
<span class="linenos"> 415</span>        <span class="n">syntax_sort</span><span class="p">:</span> <span class="n">KSyntaxSort</span> <span class="o">=</span> <span class="n">sentence</span>
<span class="linenos"> 416</span>
<span class="linenos"> 417</span>        <span class="k">if</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_sorts</span><span class="p">:</span>
<span class="linenos"> 418</span>            <span class="k">return</span> <span class="n">syntax_sort</span>
<span class="linenos"> 419</span>
<span class="linenos"> 420</span>        <span class="k">return</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">KAtt</span><span class="o">.</span><span class="n">HAS_DOMAIN_VALUES</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}))</span>
<span class="linenos"> 421</span>
<span class="linenos"> 422</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update_att</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 423</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 424</span>
<span class="linenos"> 425</span>
<span class="linenos"> 426</span><span class="k">def</span> <span class="nf">_token_sorts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">KSort</span><span class="p">]:</span>
<span class="linenos"> 427</span>    <span class="n">res</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">KSort</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 428</span>
<span class="linenos"> 429</span>    <span class="c1"># TODO &quot;token&quot; should be an attribute of only productions</span>
<span class="linenos"> 430</span>    <span class="k">for</span> <span class="n">syntax_sort</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">syntax_sorts</span><span class="p">:</span>
<span class="linenos"> 431</span>        <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">TOKEN</span> <span class="ow">in</span> <span class="n">syntax_sort</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 432</span>            <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">syntax_sort</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 433</span>
<span class="linenos"> 434</span>    <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">productions</span><span class="p">:</span>
<span class="linenos"> 435</span>        <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">TOKEN</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 436</span>            <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">production</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 437</span>
<span class="linenos"> 438</span>    <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 439</span>
<span class="linenos"> 440</span>
<span class="linenos"> 441</span><span class="k">def</span> <span class="nf">_pull_up_rewrites</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 442</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that each rule is of the form X =&gt; Y.&quot;&quot;&quot;</span>
<span class="linenos"> 443</span>
<span class="linenos"> 444</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 445</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KRule</span><span class="p">):</span>
<span class="linenos"> 446</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 447</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">KRewrite</span><span class="p">):</span>
<span class="linenos"> 448</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 449</span>        <span class="n">rewrite</span> <span class="o">=</span> <span class="n">KRewrite</span><span class="p">(</span>
<span class="linenos"> 450</span>            <span class="n">lhs</span><span class="o">=</span><span class="n">extract_lhs</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
<span class="linenos"> 451</span>            <span class="n">rhs</span><span class="o">=</span><span class="n">extract_rhs</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
<span class="linenos"> 452</span>        <span class="p">)</span>
<span class="linenos"> 453</span>        <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">rewrite</span><span class="p">)</span>
<span class="linenos"> 454</span>
<span class="linenos"> 455</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 456</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 457</span>
<span class="linenos"> 458</span>
<span class="linenos"> 459</span><span class="k">def</span> <span class="nf">_add_anywhere_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 460</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the anywhere attribute to all symbol productions that are overloads or have a corresponding anywhere rule.&quot;&quot;&quot;</span>
<span class="linenos"> 461</span>
<span class="linenos"> 462</span>    <span class="n">rules</span> <span class="o">=</span> <span class="n">_rules_by_klabel</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 463</span>    <span class="n">productions_by_klabel_att</span> <span class="o">=</span> <span class="n">_productions_by_klabel_att</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">productions</span><span class="p">)</span>
<span class="linenos"> 464</span>    <span class="n">defn</span> <span class="o">=</span> <span class="n">KDefinition</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,))</span>  <span class="c1"># for getting the sort lattice</span>
<span class="linenos"> 465</span>
<span class="linenos"> 466</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 467</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">):</span>
<span class="linenos"> 468</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 469</span>
<span class="linenos"> 470</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 471</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 472</span>
<span class="linenos"> 473</span>        <span class="n">klabel</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span>
<span class="linenos"> 474</span>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">KAtt</span><span class="o">.</span><span class="n">ANYWHERE</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">att</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">klabel</span><span class="p">,</span> <span class="p">[])):</span>
<span class="linenos"> 475</span>            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">KAtt</span><span class="o">.</span><span class="n">ANYWHERE</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}))</span>
<span class="linenos"> 476</span>
<span class="linenos"> 477</span>        <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 478</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 479</span>
<span class="linenos"> 480</span>        <span class="n">productions</span> <span class="o">=</span> <span class="n">productions_by_klabel_att</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span><span class="p">],</span> <span class="p">[])</span>
<span class="linenos"> 481</span>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">_is_overloaded_by</span><span class="p">(</span><span class="n">defn</span><span class="p">,</span> <span class="n">production</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span> <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">productions</span><span class="p">):</span>
<span class="linenos"> 482</span>            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">KAtt</span><span class="o">.</span><span class="n">ANYWHERE</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}))</span>
<span class="linenos"> 483</span>
<span class="linenos"> 484</span>        <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 485</span>
<span class="linenos"> 486</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 487</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 488</span>
<span class="linenos"> 489</span>
<span class="linenos"> 490</span><span class="k">def</span> <span class="nf">_rules_by_klabel</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">KLabel</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KRule</span><span class="p">]]:</span>
<span class="linenos"> 491</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dict that maps a label l to the list of all rules l =&gt; X.</span>
<span class="linenos"> 492</span>
<span class="linenos"> 493</span><span class="sd">    If a label does not have a matching rule, it will be not contained in the dict.</span>
<span class="linenos"> 494</span><span class="sd">    The function expects that all rules have a rewrite on top.</span>
<span class="linenos"> 495</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 496</span>    <span class="n">res</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">KLabel</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KRule</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 497</span>    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
<span class="linenos"> 498</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">KRewrite</span><span class="p">)</span>
<span class="linenos"> 499</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">KApply</span><span class="p">):</span>
<span class="linenos"> 500</span>            <span class="k">continue</span>
<span class="linenos"> 501</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">label</span>
<span class="linenos"> 502</span>        <span class="n">res</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="linenos"> 503</span>    <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span>
<span class="linenos"> 506</span><span class="k">def</span> <span class="nf">_add_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">,</span> <span class="n">att</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">KAtt</span><span class="p">],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 507</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add attribute to symbol productions based on a predicate predicate.&quot;&quot;&quot;</span>
<span class="linenos"> 508</span>
<span class="linenos"> 509</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 510</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">):</span>
<span class="linenos"> 511</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 512</span>
<span class="linenos"> 513</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>  <span class="c1"># filter for symbol productions</span>
<span class="linenos"> 514</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 515</span>
<span class="linenos"> 516</span>        <span class="k">if</span> <span class="n">pred</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="p">):</span>
<span class="linenos"> 517</span>            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">att</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}))</span>
<span class="linenos"> 518</span>
<span class="linenos"> 519</span>        <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 520</span>
<span class="linenos"> 521</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">))</span>
<span class="linenos"> 522</span>
<span class="linenos"> 523</span>
<span class="linenos"> 524</span><span class="k">def</span> <span class="nf">_is_macro</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="n">KAtt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 525</span>    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">att</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">ALIAS</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">ALIAS_REC</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">MACRO_REC</span><span class="p">])</span>
<span class="linenos"> 526</span>
<span class="linenos"> 527</span>
<span class="linenos"> 528</span><span class="k">def</span> <span class="nf">_is_functional</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="n">KAtt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 529</span>    <span class="k">return</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">FUNCTION</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">att</span> <span class="ow">or</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">TOTAL</span> <span class="ow">in</span> <span class="n">att</span>
<span class="linenos"> 530</span>
<span class="linenos"> 531</span>
<span class="linenos"> 532</span><span class="k">def</span> <span class="nf">_is_injective</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="n">KAtt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 533</span>    <span class="k">return</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
<span class="linenos"> 534</span>        <span class="n">key</span> <span class="ow">in</span> <span class="n">att</span>
<span class="linenos"> 535</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos"> 536</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">FUNCTION</span><span class="p">,</span>
<span class="linenos"> 537</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">ASSOC</span><span class="p">,</span>
<span class="linenos"> 538</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">COMM</span><span class="p">,</span>
<span class="linenos"> 539</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">IDEM</span><span class="p">,</span>
<span class="linenos"> 540</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span><span class="p">,</span>
<span class="linenos"> 541</span>        <span class="p">]</span>
<span class="linenos"> 542</span>    <span class="p">)</span>
<span class="linenos"> 543</span>
<span class="linenos"> 544</span>
<span class="linenos"> 545</span><span class="k">def</span> <span class="nf">_is_constructor</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="n">KAtt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 546</span>    <span class="k">return</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
<span class="linenos"> 547</span>        <span class="n">key</span> <span class="ow">in</span> <span class="n">att</span>
<span class="linenos"> 548</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos"> 549</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">FUNCTION</span><span class="p">,</span>
<span class="linenos"> 550</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">ASSOC</span><span class="p">,</span>
<span class="linenos"> 551</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">COMM</span><span class="p">,</span>
<span class="linenos"> 552</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">IDEM</span><span class="p">,</span>
<span class="linenos"> 553</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">UNIT</span><span class="p">,</span>
<span class="linenos"> 554</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">MACRO</span><span class="p">,</span>
<span class="linenos"> 555</span>            <span class="n">KAtt</span><span class="o">.</span><span class="n">ANYWHERE</span><span class="p">,</span>
<span class="linenos"> 556</span>        <span class="p">]</span>
<span class="linenos"> 557</span>    <span class="p">)</span>
<span class="linenos"> 558</span>
<span class="linenos"> 559</span>
<span class="linenos"> 560</span><span class="k">def</span> <span class="nf">_discard_hook_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">hook_namespaces</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 561</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove hooks attributes from symbol productions that are either 1) array hooks or 2) not built in and not activated.&quot;&quot;&quot;</span>
<span class="linenos"> 562</span>
<span class="linenos"> 563</span>    <span class="k">def</span> <span class="nf">is_real_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 564</span>        <span class="k">if</span> <span class="n">hook</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ARRAY.&#39;</span><span class="p">):</span>
<span class="linenos"> 565</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 566</span>        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">hook_namespaces</span><span class="p">,</span> <span class="o">*</span><span class="n">HOOK_NAMESPACES</span><span class="p">)</span>
<span class="linenos"> 567</span>        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">namespaces</span><span class="p">))</span>
<span class="linenos"> 568</span>
<span class="linenos"> 569</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 570</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">):</span>
<span class="linenos"> 571</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 572</span>
<span class="linenos"> 573</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 574</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 575</span>
<span class="linenos"> 576</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 577</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 578</span>
<span class="linenos"> 579</span>        <span class="n">hook</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span><span class="p">]</span>
<span class="linenos"> 580</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_real_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">):</span>
<span class="linenos"> 581</span>            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">remove</span><span class="p">([</span><span class="n">KAtt</span><span class="o">.</span><span class="n">HOOK</span><span class="p">]))</span>
<span class="linenos"> 582</span>
<span class="linenos"> 583</span>        <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 584</span>
<span class="linenos"> 585</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 586</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 587</span>
<span class="linenos"> 588</span>
<span class="linenos"> 589</span><span class="k">def</span> <span class="nf">_discard_symbol_atts</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">,</span> <span class="n">atts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">KFlatModule</span><span class="p">:</span>
<span class="linenos"> 590</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove certain attributes from symbol productions.&quot;&quot;&quot;</span>
<span class="linenos"> 591</span>
<span class="linenos"> 592</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="n">KSentence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSentence</span><span class="p">:</span>
<span class="linenos"> 593</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">KProduction</span><span class="p">):</span>
<span class="linenos"> 594</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 595</span>
<span class="linenos"> 596</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sentence</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 597</span>            <span class="k">return</span> <span class="n">sentence</span>
<span class="linenos"> 598</span>
<span class="linenos"> 599</span>        <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">att</span><span class="o">=</span><span class="n">sentence</span><span class="o">.</span><span class="n">att</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atts</span><span class="p">))</span>
<span class="linenos"> 600</span>
<span class="linenos"> 601</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">module</span><span class="p">)</span>
<span class="linenos"> 602</span>    <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">sentences</span><span class="o">=</span><span class="n">sentences</span><span class="p">)</span>
<span class="linenos"> 603</span>
<span class="linenos"> 604</span>
<span class="linenos"> 605</span><span class="k">def</span> <span class="nf">_productions_by_klabel_att</span><span class="p">(</span><span class="n">productions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">KProduction</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KProduction</span><span class="p">]]:</span>
<span class="linenos"> 606</span>    <span class="n">res</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">KProduction</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 607</span>    <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">productions</span><span class="p">:</span>
<span class="linenos"> 608</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">production</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 609</span>            <span class="k">continue</span>
<span class="linenos"> 610</span>        <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">production</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 611</span>            <span class="k">continue</span>
<span class="linenos"> 612</span>        <span class="n">res</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">production</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
<span class="linenos"> 613</span>    <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 614</span>
<span class="linenos"> 615</span>
<span class="linenos"> 616</span><span class="k">def</span> <span class="nf">_is_overloaded_by</span><span class="p">(</span><span class="n">defn</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">prod1</span><span class="p">:</span> <span class="n">KProduction</span><span class="p">,</span> <span class="n">prod2</span><span class="p">:</span> <span class="n">KProduction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 617</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">prod1</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 618</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected symbol production, got: </span><span class="si">{</span><span class="n">prod1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 619</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">prod2</span><span class="o">.</span><span class="n">klabel</span><span class="p">:</span>
<span class="linenos"> 620</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected symbol production, got: </span><span class="si">{</span><span class="n">prod2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 621</span>    <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prod1</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 622</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 623</span>    <span class="k">if</span> <span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prod2</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 624</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 625</span>    <span class="k">if</span> <span class="n">prod1</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span><span class="p">]</span> <span class="o">!=</span> <span class="n">prod2</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="n">KAtt</span><span class="o">.</span><span class="n">KLABEL</span><span class="p">]:</span>
<span class="linenos"> 626</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 627</span>    <span class="n">arg_sorts1</span> <span class="o">=</span> <span class="n">prod1</span><span class="o">.</span><span class="n">argument_sorts</span>
<span class="linenos"> 628</span>    <span class="n">arg_sorts2</span> <span class="o">=</span> <span class="n">prod2</span><span class="o">.</span><span class="n">argument_sorts</span>
<span class="linenos"> 629</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_sorts1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_sorts2</span><span class="p">):</span>
<span class="linenos"> 630</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 631</span>    <span class="k">if</span> <span class="n">prod1</span><span class="o">.</span><span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="p">(</span><span class="n">prod2</span><span class="o">.</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 632</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 633</span>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">sort1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="p">(</span><span class="n">sort2</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort1</span><span class="p">,</span> <span class="n">sort2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_sorts1</span><span class="p">,</span> <span class="n">arg_sorts2</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
<span class="linenos"> 634</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 635</span>    <span class="k">return</span> <span class="n">prod1</span> <span class="o">!=</span> <span class="n">prod2</span>
<span class="linenos"> 636</span>
<span class="linenos"> 637</span>
<span class="linenos"> 638</span><span class="c1"># ------------</span>
<span class="linenos"> 639</span><span class="c1"># KAST-to-KORE</span>
<span class="linenos"> 640</span><span class="c1"># ------------</span>
<span class="linenos"> 641</span>
<span class="linenos"> 642</span><span class="n">ML_CONN_LABELS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 643</span>    <span class="s1">&#39;#Top&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\top&#39;</span><span class="p">,</span>
<span class="linenos"> 644</span>    <span class="s1">&#39;#Bottom&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\bottom&#39;</span><span class="p">,</span>
<span class="linenos"> 645</span>    <span class="s1">&#39;#Not&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\not&#39;</span><span class="p">,</span>
<span class="linenos"> 646</span>    <span class="s1">&#39;#And&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\and&#39;</span><span class="p">,</span>
<span class="linenos"> 647</span>    <span class="s1">&#39;#Or&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\or&#39;</span><span class="p">,</span>
<span class="linenos"> 648</span>    <span class="s1">&#39;#Implies&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\implies&#39;</span><span class="p">,</span>
<span class="linenos"> 649</span>    <span class="s1">&#39;#Iff&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\iff&#39;</span><span class="p">,</span>
<span class="linenos"> 650</span><span class="p">}</span>
<span class="linenos"> 651</span>
<span class="linenos"> 652</span><span class="n">ML_QUANT_LABELS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 653</span>    <span class="s1">&#39;#Exists&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\exists&#39;</span><span class="p">,</span>
<span class="linenos"> 654</span>    <span class="s1">&#39;#Forall&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\forall&#39;</span><span class="p">,</span>
<span class="linenos"> 655</span><span class="p">}</span>
<span class="linenos"> 656</span>
<span class="linenos"> 657</span><span class="n">ML_PRED_LABELS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 658</span>    <span class="s1">&#39;#Ceil&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\ceil&#39;</span><span class="p">,</span>
<span class="linenos"> 659</span>    <span class="s1">&#39;#Floor&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\floor&#39;</span><span class="p">,</span>
<span class="linenos"> 660</span>    <span class="s1">&#39;#Equals&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\equals&#39;</span><span class="p">,</span>
<span class="linenos"> 661</span>    <span class="s1">&#39;#In&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;\in&#39;</span><span class="p">,</span>
<span class="linenos"> 662</span><span class="p">}</span>
<span class="linenos"> 663</span>
<span class="linenos"> 664</span><span class="n">ML_PATTERN_LABELS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos"> 665</span>    <span class="o">**</span><span class="n">ML_CONN_LABELS</span><span class="p">,</span>
<span class="linenos"> 666</span>    <span class="o">**</span><span class="n">ML_QUANT_LABELS</span><span class="p">,</span>
<span class="linenos"> 667</span>    <span class="o">**</span><span class="n">ML_PRED_LABELS</span><span class="p">,</span>
<span class="linenos"> 668</span><span class="p">)</span>
<span class="linenos"> 669</span>
<span class="linenos"> 670</span>
<div class="viewcode-block" id="kast_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.kast_to_kore">[docs]</a>
<span class="linenos"> 671</span><span class="k">def</span> <span class="nf">kast_to_kore</span><span class="p">(</span>
<span class="linenos"> 672</span>    <span class="n">kast_defn</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span>
<span class="linenos"> 673</span>    <span class="n">kompiled_kore</span><span class="p">:</span> <span class="n">KompiledKore</span><span class="p">,</span>
<span class="linenos"> 674</span>    <span class="n">kast</span><span class="p">:</span> <span class="n">KInner</span><span class="p">,</span>
<span class="linenos"> 675</span>    <span class="n">sort</span><span class="p">:</span> <span class="n">KSort</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 676</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 677</span>    <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 678</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">K</span>
<span class="linenos"> 679</span>    <span class="n">kast</span> <span class="o">=</span> <span class="n">kast_defn</span><span class="o">.</span><span class="n">add_ksequence_under_k_productions</span><span class="p">(</span><span class="n">kast</span><span class="p">)</span>
<span class="linenos"> 680</span>    <span class="n">kast</span> <span class="o">=</span> <span class="n">kast_defn</span><span class="o">.</span><span class="n">sort_vars</span><span class="p">(</span><span class="n">kast</span><span class="p">,</span> <span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 681</span>    <span class="n">kast</span> <span class="o">=</span> <span class="n">kast_defn</span><span class="o">.</span><span class="n">add_cell_map_items</span><span class="p">(</span><span class="n">kast</span><span class="p">)</span>
<span class="linenos"> 682</span>    <span class="n">kast</span> <span class="o">=</span> <span class="n">kast_defn</span><span class="o">.</span><span class="n">add_sort_params</span><span class="p">(</span><span class="n">kast</span><span class="p">)</span>
<span class="linenos"> 683</span>    <span class="n">kore</span> <span class="o">=</span> <span class="n">_kast_to_kore</span><span class="p">(</span><span class="n">kast</span><span class="p">)</span>
<span class="linenos"> 684</span>    <span class="n">kore</span> <span class="o">=</span> <span class="n">kompiled_kore</span><span class="o">.</span><span class="n">add_injections</span><span class="p">(</span><span class="n">kore</span><span class="p">,</span> <span class="n">_ksort_to_kore</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 685</span>    <span class="k">return</span> <span class="n">kore</span></div>

<span class="linenos"> 686</span>
<span class="linenos"> 687</span>
<span class="linenos"> 688</span><span class="c1"># &#39;krule&#39; should have sorts on variables</span>
<div class="viewcode-block" id="krule_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.krule_to_kore">[docs]</a>
<span class="linenos"> 689</span><span class="k">def</span> <span class="nf">krule_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">:</span> <span class="n">KompiledKore</span><span class="p">,</span> <span class="n">krule</span><span class="p">:</span> <span class="n">KRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axiom</span><span class="p">:</span>
<span class="linenos"> 690</span>    <span class="n">krule_body</span> <span class="o">=</span> <span class="n">krule</span><span class="o">.</span><span class="n">body</span>
<span class="linenos"> 691</span>    <span class="n">krule_lhs</span> <span class="o">=</span> <span class="n">CTerm</span><span class="p">(</span><span class="n">extract_lhs</span><span class="p">(</span><span class="n">krule_body</span><span class="p">),</span> <span class="p">[</span><span class="n">bool_to_ml_pred</span><span class="p">(</span><span class="n">krule</span><span class="o">.</span><span class="n">requires</span><span class="p">)])</span>
<span class="linenos"> 692</span>    <span class="n">krule_rhs</span> <span class="o">=</span> <span class="n">CTerm</span><span class="p">(</span><span class="n">extract_rhs</span><span class="p">(</span><span class="n">krule_body</span><span class="p">),</span> <span class="p">[</span><span class="n">bool_to_ml_pred</span><span class="p">(</span><span class="n">krule</span><span class="o">.</span><span class="n">ensures</span><span class="p">)])</span>
<span class="linenos"> 693</span>
<span class="linenos"> 694</span>    <span class="n">top_level_kore_sort</span> <span class="o">=</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortGeneratedTopCell&#39;</span><span class="p">)</span>
<span class="linenos"> 695</span>    <span class="n">top_level_k_sort</span> <span class="o">=</span> <span class="n">KSort</span><span class="p">(</span><span class="s1">&#39;GeneratedTopCell&#39;</span><span class="p">)</span>
<span class="linenos"> 696</span>    <span class="c1"># The backend does not like rewrite rules without a precondition</span>
<span class="linenos"> 697</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">krule_lhs</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 698</span>        <span class="n">kore_lhs0</span><span class="p">:</span> <span class="n">Pattern</span> <span class="o">=</span> <span class="n">kast_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">,</span> <span class="n">krule_lhs</span><span class="o">.</span><span class="n">kast</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">top_level_k_sort</span><span class="p">)</span>
<span class="linenos"> 699</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 700</span>        <span class="n">kore_lhs0</span> <span class="o">=</span> <span class="n">And</span><span class="p">(</span>
<span class="linenos"> 701</span>            <span class="n">top_level_kore_sort</span><span class="p">,</span>
<span class="linenos"> 702</span>            <span class="p">(</span>
<span class="linenos"> 703</span>                <span class="n">kast_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">,</span> <span class="n">krule_lhs</span><span class="o">.</span><span class="n">kast</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">top_level_k_sort</span><span class="p">),</span>
<span class="linenos"> 704</span>                <span class="n">Top</span><span class="p">(</span><span class="n">top_level_kore_sort</span><span class="p">),</span>
<span class="linenos"> 705</span>            <span class="p">),</span>
<span class="linenos"> 706</span>        <span class="p">)</span>
<span class="linenos"> 707</span>
<span class="linenos"> 708</span>    <span class="n">kore_rhs0</span><span class="p">:</span> <span class="n">Pattern</span> <span class="o">=</span> <span class="n">kast_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">,</span> <span class="n">krule_rhs</span><span class="o">.</span><span class="n">kast</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">top_level_k_sort</span><span class="p">)</span>
<span class="linenos"> 709</span>
<span class="linenos"> 710</span>    <span class="n">kore_lhs</span> <span class="o">=</span> <span class="n">kompiled_kore</span><span class="o">.</span><span class="n">add_injections</span><span class="p">(</span><span class="n">kore_lhs0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">top_level_kore_sort</span><span class="p">)</span>
<span class="linenos"> 711</span>    <span class="n">kore_rhs</span> <span class="o">=</span> <span class="n">kompiled_kore</span><span class="o">.</span><span class="n">add_injections</span><span class="p">(</span><span class="n">kore_rhs0</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">top_level_kore_sort</span><span class="p">)</span>
<span class="linenos"> 712</span>    <span class="n">prio</span> <span class="o">=</span> <span class="n">krule</span><span class="o">.</span><span class="n">priority</span>
<span class="linenos"> 713</span>    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="n">sorts</span><span class="o">=</span><span class="p">(),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prio</span><span class="p">)),))]</span>
<span class="linenos"> 714</span>    <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">krule</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
<span class="linenos"> 715</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">krule</span><span class="o">.</span><span class="n">att</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
<span class="linenos"> 716</span>        <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">sorts</span><span class="o">=</span><span class="p">(),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">label</span><span class="p">),)))</span>
<span class="linenos"> 717</span>    <span class="n">axiom</span> <span class="o">=</span> <span class="n">Axiom</span><span class="p">(</span>
<span class="linenos"> 718</span>        <span class="nb">vars</span><span class="o">=</span><span class="p">(),</span>
<span class="linenos"> 719</span>        <span class="n">pattern</span><span class="o">=</span><span class="n">Rewrites</span><span class="p">(</span>
<span class="linenos"> 720</span>            <span class="n">sort</span><span class="o">=</span><span class="n">top_level_kore_sort</span><span class="p">,</span>
<span class="linenos"> 721</span>            <span class="n">left</span><span class="o">=</span><span class="n">kore_lhs</span><span class="p">,</span>
<span class="linenos"> 722</span>            <span class="n">right</span><span class="o">=</span><span class="n">kore_rhs</span><span class="p">,</span>
<span class="linenos"> 723</span>        <span class="p">),</span>
<span class="linenos"> 724</span>        <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span>
<span class="linenos"> 725</span>    <span class="p">)</span>
<span class="linenos"> 726</span>    <span class="k">return</span> <span class="n">axiom</span></div>

<span class="linenos"> 727</span>
<span class="linenos"> 728</span>
<div class="viewcode-block" id="kflatmodule_to_kore">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.kflatmodule_to_kore">[docs]</a>
<span class="linenos"> 729</span><span class="k">def</span> <span class="nf">kflatmodule_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">:</span> <span class="n">KompiledKore</span><span class="p">,</span> <span class="n">kflatmodule</span><span class="p">:</span> <span class="n">KFlatModule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos"> 730</span>    <span class="n">kore_axioms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Sentence</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 731</span>    <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">kflatmodule</span><span class="o">.</span><span class="n">sentences</span><span class="p">:</span>
<span class="linenos"> 732</span>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">KRule</span><span class="p">:</span>
<span class="linenos"> 733</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot convert sentence to Kore: </span><span class="si">{</span><span class="n">sent</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 734</span>        <span class="n">kore_axioms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">krule_to_kore</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">,</span> <span class="n">kompiled_kore</span><span class="p">,</span> <span class="n">sent</span><span class="p">))</span>
<span class="linenos"> 735</span>    <span class="n">imports</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Sentence</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_kimport_to_kore</span><span class="p">(</span><span class="n">kimport</span><span class="p">)</span> <span class="k">for</span> <span class="n">kimport</span> <span class="ow">in</span> <span class="n">kflatmodule</span><span class="o">.</span><span class="n">imports</span><span class="p">]</span>
<span class="linenos"> 736</span>    <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">kflatmodule</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sentences</span><span class="o">=</span><span class="p">(</span><span class="n">imports</span> <span class="o">+</span> <span class="n">kore_axioms</span><span class="p">))</span></div>

<span class="linenos"> 737</span>
<span class="linenos"> 738</span>
<span class="linenos"> 739</span><span class="k">def</span> <span class="nf">_kimport_to_kore</span><span class="p">(</span><span class="n">kimport</span><span class="p">:</span> <span class="n">KImport</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Import</span><span class="p">:</span>
<span class="linenos"> 740</span>    <span class="k">return</span> <span class="n">Import</span><span class="p">(</span><span class="n">module_name</span><span class="o">=</span><span class="n">kimport</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">())</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span>
<span class="linenos"> 743</span><span class="k">def</span> <span class="nf">_ksort_to_kore</span><span class="p">(</span><span class="n">ksort</span><span class="p">:</span> <span class="n">KSort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SortApp</span><span class="p">:</span>
<span class="linenos"> 744</span>    <span class="k">return</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Sort&#39;</span> <span class="o">+</span> <span class="n">ksort</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 745</span>
<span class="linenos"> 746</span>
<span class="linenos"> 747</span><span class="k">def</span> <span class="nf">_kast_to_kore</span><span class="p">(</span><span class="n">term</span><span class="p">:</span> <span class="n">KInner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 748</span>    <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span><span class="p">,</span> <span class="p">[]]</span>
<span class="linenos"> 749</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 750</span>        <span class="n">patterns</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 751</span>        <span class="n">term</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 752</span>        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span>
<span class="linenos"> 753</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span><span class="p">:</span>
<span class="linenos"> 754</span>            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 755</span>            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 756</span>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">_kinner_to_kore</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 757</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
<span class="linenos"> 758</span>                <span class="k">return</span> <span class="n">pattern</span>
<span class="linenos"> 759</span>            <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="linenos"> 760</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 761</span>            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">terms</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="linenos"> 762</span>            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
<span class="linenos"> 763</span>
<span class="linenos"> 764</span>
<span class="linenos"> 765</span><span class="k">def</span> <span class="nf">_kinner_to_kore</span><span class="p">(</span><span class="n">kinner</span><span class="p">:</span> <span class="n">KInner</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 766</span>    <span class="k">match</span> <span class="n">kinner</span><span class="p">:</span>
<span class="linenos"> 767</span>        <span class="k">case</span> <span class="n">KToken</span><span class="p">():</span>
<span class="linenos"> 768</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">patterns</span>
<span class="linenos"> 769</span>            <span class="k">return</span> <span class="n">_ktoken_to_kore</span><span class="p">(</span><span class="n">kinner</span><span class="p">)</span>
<span class="linenos"> 770</span>        <span class="k">case</span> <span class="n">KVariable</span><span class="p">():</span>
<span class="linenos"> 771</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">patterns</span>
<span class="linenos"> 772</span>            <span class="k">return</span> <span class="n">_kvariable_to_kore</span><span class="p">(</span><span class="n">kinner</span><span class="p">)</span>
<span class="linenos"> 773</span>        <span class="k">case</span> <span class="n">KSequence</span><span class="p">():</span>
<span class="linenos"> 774</span>            <span class="k">return</span> <span class="n">_ksequence_to_kore</span><span class="p">(</span><span class="n">kinner</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 775</span>        <span class="k">case</span> <span class="n">KApply</span><span class="p">():</span>
<span class="linenos"> 776</span>            <span class="k">return</span> <span class="n">_kapply_to_kore</span><span class="p">(</span><span class="n">kinner</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 777</span>        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos"> 778</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported KInner: </span><span class="si">{</span><span class="n">kinner</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 779</span>
<span class="linenos"> 780</span>
<span class="linenos"> 781</span><span class="k">def</span> <span class="nf">_ktoken_to_kore</span><span class="p">(</span><span class="n">ktoken</span><span class="p">:</span> <span class="n">KToken</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DV</span><span class="p">:</span>
<span class="linenos"> 782</span>    <span class="n">value</span><span class="p">:</span> <span class="n">String</span>
<span class="linenos"> 783</span>    <span class="k">if</span> <span class="n">ktoken</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">STRING</span><span class="p">:</span>
<span class="linenos"> 784</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">pretty_string</span><span class="p">(</span><span class="n">ktoken</span><span class="p">))</span>
<span class="linenos"> 785</span>    <span class="k">elif</span> <span class="n">ktoken</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">BYTES</span><span class="p">:</span>
<span class="linenos"> 786</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">pretty_bytes_str</span><span class="p">(</span><span class="n">ktoken</span><span class="p">))</span>
<span class="linenos"> 787</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 788</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">ktoken</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
<span class="linenos"> 789</span>
<span class="linenos"> 790</span>    <span class="n">sort</span> <span class="o">=</span> <span class="n">_ksort_to_kore</span><span class="p">(</span><span class="n">ktoken</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 791</span>
<span class="linenos"> 792</span>    <span class="k">return</span> <span class="n">DV</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 793</span>
<span class="linenos"> 794</span>
<span class="linenos"> 795</span><span class="k">def</span> <span class="nf">_kvariable_to_kore</span><span class="p">(</span><span class="n">kvar</span><span class="p">:</span> <span class="n">KVariable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EVar</span><span class="p">:</span>
<span class="linenos"> 796</span>    <span class="n">sort</span><span class="p">:</span> <span class="n">Sort</span>
<span class="linenos"> 797</span>    <span class="k">if</span> <span class="n">kvar</span><span class="o">.</span><span class="n">sort</span><span class="p">:</span>
<span class="linenos"> 798</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">_ksort_to_kore</span><span class="p">(</span><span class="n">kvar</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 799</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 800</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">SORT_K</span>
<span class="linenos"> 801</span>    <span class="k">return</span> <span class="n">EVar</span><span class="p">(</span><span class="s1">&#39;Var&#39;</span> <span class="o">+</span> <span class="n">munge</span><span class="p">(</span><span class="n">kvar</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 802</span>
<span class="linenos"> 803</span>
<span class="linenos"> 804</span><span class="k">def</span> <span class="nf">_ksequence_to_kore</span><span class="p">(</span><span class="n">kseq</span><span class="p">:</span> <span class="n">KSequence</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 805</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
<span class="linenos"> 806</span>        <span class="k">return</span> <span class="n">DOTK</span>
<span class="linenos"> 807</span>
<span class="linenos"> 808</span>    <span class="n">unit</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="linenos"> 809</span>    <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span>
<span class="linenos"> 810</span>
<span class="linenos"> 811</span>    <span class="n">last</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 812</span>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="ow">is</span> <span class="n">EVar</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">SORT_K</span><span class="p">:</span>
<span class="linenos"> 813</span>        <span class="n">unit</span> <span class="o">=</span> <span class="n">last</span>
<span class="linenos"> 814</span>        <span class="n">args</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 815</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 816</span>        <span class="n">unit</span> <span class="o">=</span> <span class="n">DOTK</span>
<span class="linenos"> 817</span>        <span class="n">args</span> <span class="o">=</span> <span class="n">patterns</span>
<span class="linenos"> 818</span>
<span class="linenos"> 819</span>    <span class="n">args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="linenos"> 820</span>    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">App</span><span class="p">(</span><span class="s1">&#39;kseq&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span> <span class="n">args</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
<span class="linenos"> 821</span>
<span class="linenos"> 822</span>
<span class="linenos"> 823</span><span class="k">def</span> <span class="nf">_kapply_to_kore</span><span class="p">(</span><span class="n">kapply</span><span class="p">:</span> <span class="n">KApply</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 824</span>    <span class="k">if</span> <span class="n">kapply</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">ML_QUANT_LABELS</span><span class="p">:</span>
<span class="linenos"> 825</span>        <span class="k">return</span> <span class="n">_kapply_to_ml_quant</span><span class="p">(</span><span class="n">kapply</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 826</span>
<span class="linenos"> 827</span>    <span class="k">return</span> <span class="n">_kapply_to_pattern</span><span class="p">(</span><span class="n">kapply</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 828</span>
<span class="linenos"> 829</span>
<span class="linenos"> 830</span><span class="k">def</span> <span class="nf">_kapply_to_ml_quant</span><span class="p">(</span><span class="n">kapply</span><span class="p">:</span> <span class="n">KApply</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MLQuant</span><span class="p">:</span>
<span class="linenos"> 831</span>    <span class="n">label</span> <span class="o">=</span> <span class="n">kapply</span><span class="o">.</span><span class="n">label</span>
<span class="linenos"> 832</span>    <span class="n">symbol</span> <span class="o">=</span> <span class="n">ML_QUANT_LABELS</span><span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
<span class="linenos"> 833</span>    <span class="n">sorts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_ksort_to_kore</span><span class="p">(</span><span class="n">ksort</span><span class="p">)</span> <span class="k">for</span> <span class="n">ksort</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="linenos"> 834</span>    <span class="k">return</span> <span class="n">MLQuant</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 835</span>
<span class="linenos"> 836</span>
<span class="linenos"> 837</span><span class="k">def</span> <span class="nf">_kapply_to_pattern</span><span class="p">(</span><span class="n">kapply</span><span class="p">:</span> <span class="n">KApply</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 838</span>    <span class="n">label</span> <span class="o">=</span> <span class="n">kapply</span><span class="o">.</span><span class="n">label</span>
<span class="linenos"> 839</span>    <span class="n">symbol</span> <span class="o">=</span> <span class="n">_label_to_kore</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 840</span>    <span class="n">sorts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_ksort_to_kore</span><span class="p">(</span><span class="n">ksort</span><span class="p">)</span> <span class="k">for</span> <span class="n">ksort</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="linenos"> 841</span>
<span class="linenos"> 842</span>    <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">ML_PATTERN_LABELS</span><span class="p">:</span>
<span class="linenos"> 843</span>        <span class="k">return</span> <span class="n">MLPattern</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 844</span>
<span class="linenos"> 845</span>    <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 846</span>
<span class="linenos"> 847</span>
<span class="linenos"> 848</span><span class="k">def</span> <span class="nf">_label_to_kore</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 849</span>    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ML_PATTERN_LABELS</span><span class="p">:</span>
<span class="linenos"> 850</span>        <span class="k">return</span> <span class="n">ML_PATTERN_LABELS</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
<span class="linenos"> 851</span>
<span class="linenos"> 852</span>    <span class="k">return</span> <span class="s1">&#39;Lbl&#39;</span> <span class="o">+</span> <span class="n">munge</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<span class="linenos"> 853</span>
<span class="linenos"> 854</span>
<span class="linenos"> 855</span><span class="c1"># ------------</span>
<span class="linenos"> 856</span><span class="c1"># KORE-to-KAST</span>
<span class="linenos"> 857</span><span class="c1"># ------------</span>
<span class="linenos"> 858</span>
<span class="linenos"> 859</span>
<div class="viewcode-block" id="kore_to_kast">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.kore_to_kast">[docs]</a>
<span class="linenos"> 860</span><span class="k">def</span> <span class="nf">kore_to_kast</span><span class="p">(</span><span class="n">kast_defn</span><span class="p">:</span> <span class="n">KDefinition</span><span class="p">,</span> <span class="n">kore</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KInner</span><span class="p">:</span>
<span class="linenos"> 861</span>    <span class="n">kast</span> <span class="o">=</span> <span class="n">_kore_to_kast</span><span class="p">(</span><span class="n">kore</span><span class="p">)</span>
<span class="linenos"> 862</span>    <span class="k">return</span> <span class="n">kast_defn</span><span class="o">.</span><span class="n">remove_cell_map_items</span><span class="p">(</span><span class="n">kast</span><span class="p">)</span></div>

<span class="linenos"> 863</span>
<span class="linenos"> 864</span>
<span class="linenos"> 865</span><span class="k">def</span> <span class="nf">_kore_to_kast</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KInner</span><span class="p">:</span>
<span class="linenos"> 866</span>    <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">Assoc</span><span class="p">)</span> <span class="k">else</span> <span class="n">pattern</span><span class="p">,</span> <span class="p">[]]</span>
<span class="linenos"> 867</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 868</span>        <span class="n">terms</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 869</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 870</span>        <span class="n">patterns</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">patterns</span>
<span class="linenos"> 871</span>        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
<span class="linenos"> 872</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span><span class="p">:</span>
<span class="linenos"> 873</span>            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 874</span>            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="linenos"> 875</span>            <span class="n">term</span> <span class="o">=</span> <span class="n">_pattern_to_kast</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>
<span class="linenos"> 876</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
<span class="linenos"> 877</span>                <span class="k">return</span> <span class="n">term</span>
<span class="linenos"> 878</span>            <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
<span class="linenos"> 879</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 880</span>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="linenos"> 881</span>            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">Assoc</span><span class="p">)</span> <span class="k">else</span> <span class="n">pattern</span><span class="p">)</span>
<span class="linenos"> 882</span>            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
<span class="linenos"> 883</span>
<span class="linenos"> 884</span>
<span class="linenos"> 885</span><span class="k">def</span> <span class="nf">_pattern_to_kast</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">KInner</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">KInner</span><span class="p">:</span>
<span class="linenos"> 886</span>    <span class="k">match</span> <span class="n">pattern</span><span class="p">:</span>
<span class="linenos"> 887</span>        <span class="k">case</span> <span class="n">DV</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
<span class="linenos"> 888</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">terms</span>
<span class="linenos"> 889</span>            <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="n">KORE_STRING</span><span class="p">:</span>
<span class="linenos"> 890</span>                <span class="k">return</span> <span class="n">stringToken</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 891</span>            <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="n">KORE_BYTES</span><span class="p">:</span>
<span class="linenos"> 892</span>                <span class="k">return</span> <span class="n">bytesToken_from_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 893</span>            <span class="k">return</span> <span class="n">KToken</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 894</span>
<span class="linenos"> 895</span>        <span class="k">case</span> <span class="n">EVar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 896</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">terms</span>
<span class="linenos"> 897</span>            <span class="k">return</span> <span class="n">KVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">unmunge</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 898</span>
<span class="linenos"> 899</span>        <span class="k">case</span><span class="w"> </span><span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="k">_</span><span class="p">):</span>
<span class="linenos"> 900</span>            <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;inj&#39;</span><span class="p">:</span>
<span class="linenos"> 901</span>                <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos"> 902</span>                <span class="p">(</span><span class="n">term</span><span class="p">,)</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 903</span>                <span class="k">return</span> <span class="n">term</span>
<span class="linenos"> 904</span>
<span class="linenos"> 905</span>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">sorts</span><span class="p">:</span>
<span class="linenos"> 906</span>                <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;dotk&#39;</span><span class="p">:</span>
<span class="linenos"> 907</span>                    <span class="p">()</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 908</span>                    <span class="k">return</span> <span class="n">KSequence</span><span class="p">(())</span>
<span class="linenos"> 909</span>
<span class="linenos"> 910</span>                <span class="k">elif</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;kseq&#39;</span><span class="p">:</span>
<span class="linenos"> 911</span>                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 912</span>                    <span class="k">return</span> <span class="n">KSequence</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
<span class="linenos"> 913</span>
<span class="linenos"> 914</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 915</span>                    <span class="n">klabel</span> <span class="o">=</span> <span class="n">KLabel</span><span class="p">(</span><span class="n">unmunge</span><span class="p">(</span><span class="n">symbol</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
<span class="linenos"> 916</span>                    <span class="k">return</span> <span class="n">KApply</span><span class="p">(</span><span class="n">klabel</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>
<span class="linenos"> 917</span>
<span class="linenos"> 918</span>            <span class="c1"># hardcoded polymorphic operators</span>
<span class="linenos"> 919</span>            <span class="k">elif</span> <span class="p">(</span>
<span class="linenos"> 920</span>                <span class="n">symbol</span>
<span class="linenos"> 921</span>                <span class="o">==</span> <span class="s2">&quot;Lbl&#39;Hash&#39;if&#39;UndsHash&#39;then&#39;UndsHash&#39;else&#39;UndsHash&#39;fi&#39;Unds&#39;K-EQUAL-SYNTAX&#39;Unds&#39;Sort&#39;Unds&#39;Bool&#39;Unds&#39;Sort&#39;Unds&#39;Sort&quot;</span>
<span class="linenos"> 922</span>            <span class="p">):</span>
<span class="linenos"> 923</span>                <span class="p">(</span><span class="n">sort</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos"> 924</span>                <span class="n">klabel</span> <span class="o">=</span> <span class="n">KLabel</span><span class="p">(</span><span class="n">unmunge</span><span class="p">(</span><span class="n">symbol</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="p">(</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">),))</span>
<span class="linenos"> 925</span>                <span class="k">return</span> <span class="n">KApply</span><span class="p">(</span><span class="n">klabel</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>
<span class="linenos"> 926</span>
<span class="linenos"> 927</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 928</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported polymorphic operator: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 929</span>
<span class="linenos"> 930</span>        <span class="k">case</span> <span class="n">Top</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 931</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">terms</span>
<span class="linenos"> 932</span>            <span class="k">return</span> <span class="n">mlTop</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 933</span>
<span class="linenos"> 934</span>        <span class="k">case</span> <span class="n">Bottom</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 935</span>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">terms</span>
<span class="linenos"> 936</span>            <span class="k">return</span> <span class="n">mlBottom</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 937</span>
<span class="linenos"> 938</span>        <span class="k">case</span><span class="w"> </span><span class="n">And</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="k">_</span><span class="p">):</span>
<span class="linenos"> 939</span>            <span class="k">return</span> <span class="n">mlAnd</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 940</span>
<span class="linenos"> 941</span>        <span class="k">case</span><span class="w"> </span><span class="n">Implies</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="k">_</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="linenos"> 942</span>            <span class="n">larg</span><span class="p">,</span> <span class="n">rarg</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 943</span>            <span class="k">return</span> <span class="n">mlImplies</span><span class="p">(</span><span class="n">larg</span><span class="p">,</span> <span class="n">rarg</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 944</span>
<span class="linenos"> 945</span>        <span class="k">case</span><span class="w"> </span><span class="n">Not</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="k">_</span><span class="p">):</span>
<span class="linenos"> 946</span>            <span class="p">(</span><span class="n">karg</span><span class="p">,)</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 947</span>            <span class="k">return</span> <span class="n">mlNot</span><span class="p">(</span><span class="n">karg</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 948</span>
<span class="linenos"> 949</span>        <span class="k">case</span><span class="w"> </span><span class="n">Exists</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">EVar</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">vsort</span><span class="p">),</span> <span class="k">_</span><span class="p">):</span>
<span class="linenos"> 950</span>            <span class="n">kvar</span> <span class="o">=</span> <span class="n">KVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">unmunge</span><span class="p">(</span><span class="n">vname</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">vsort</span><span class="p">))</span>
<span class="linenos"> 951</span>            <span class="p">(</span><span class="n">body</span><span class="p">,)</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 952</span>            <span class="k">return</span> <span class="n">mlExists</span><span class="p">(</span><span class="n">kvar</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 953</span>
<span class="linenos"> 954</span>        <span class="k">case</span> <span class="n">Equals</span><span class="p">(</span><span class="n">op_sort</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="linenos"> 955</span>            <span class="n">larg</span><span class="p">,</span> <span class="n">rarg</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 956</span>            <span class="k">return</span> <span class="n">mlEquals</span><span class="p">(</span>
<span class="linenos"> 957</span>                <span class="n">larg</span><span class="p">,</span>
<span class="linenos"> 958</span>                <span class="n">rarg</span><span class="p">,</span>
<span class="linenos"> 959</span>                <span class="n">arg_sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">op_sort</span><span class="p">),</span>
<span class="linenos"> 960</span>                <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">),</span>
<span class="linenos"> 961</span>            <span class="p">)</span>
<span class="linenos"> 962</span>
<span class="linenos"> 963</span>        <span class="k">case</span> <span class="n">Ceil</span><span class="p">(</span><span class="n">op_sort</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="linenos"> 964</span>            <span class="p">(</span><span class="n">karg</span><span class="p">,)</span> <span class="o">=</span> <span class="n">terms</span>
<span class="linenos"> 965</span>            <span class="k">return</span> <span class="n">mlCeil</span><span class="p">(</span>
<span class="linenos"> 966</span>                <span class="n">karg</span><span class="p">,</span>
<span class="linenos"> 967</span>                <span class="n">arg_sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">op_sort</span><span class="p">),</span>
<span class="linenos"> 968</span>                <span class="n">sort</span><span class="o">=</span><span class="n">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">),</span>
<span class="linenos"> 969</span>            <span class="p">)</span>
<span class="linenos"> 970</span>
<span class="linenos"> 971</span>        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos"> 972</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported Pattern: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 973</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span><span class="k">def</span> <span class="nf">_sort_to_kast</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="n">Sort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KSort</span><span class="p">:</span>
<span class="linenos"> 976</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Sort&#39;</span><span class="p">):</span>
<span class="linenos"> 977</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported Sort: </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 978</span>    <span class="k">return</span> <span class="n">KSort</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
<span class="linenos"> 979</span>
<span class="linenos"> 980</span>
<span class="linenos"> 981</span><span class="c1"># --------------</span>
<span class="linenos"> 982</span><span class="c1"># Symbol munging</span>
<span class="linenos"> 983</span><span class="c1"># --------------</span>
<span class="linenos"> 984</span>
<span class="linenos"> 985</span><span class="n">UNMUNGE_TABLE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">FrozenDict</span><span class="p">(</span>
<span class="linenos"> 986</span>    <span class="p">{</span>
<span class="linenos"> 987</span>        <span class="s1">&#39;Spce&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
<span class="linenos"> 988</span>        <span class="s1">&#39;Bang&#39;</span><span class="p">:</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
<span class="linenos"> 989</span>        <span class="s1">&#39;Quot&#39;</span><span class="p">:</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
<span class="linenos"> 990</span>        <span class="s1">&#39;Hash&#39;</span><span class="p">:</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>
<span class="linenos"> 991</span>        <span class="s1">&#39;Dolr&#39;</span><span class="p">:</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span>
<span class="linenos"> 992</span>        <span class="s1">&#39;Perc&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
<span class="linenos"> 993</span>        <span class="s1">&#39;And-&#39;</span><span class="p">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
<span class="linenos"> 994</span>        <span class="s1">&#39;Apos&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
<span class="linenos"> 995</span>        <span class="s1">&#39;LPar&#39;</span><span class="p">:</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span>
<span class="linenos"> 996</span>        <span class="s1">&#39;RPar&#39;</span><span class="p">:</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
<span class="linenos"> 997</span>        <span class="s1">&#39;Star&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="linenos"> 998</span>        <span class="s1">&#39;Plus&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span>
<span class="linenos"> 999</span>        <span class="s1">&#39;Comm&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span>
<span class="linenos">1000</span>        <span class="s1">&#39;Stop&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
<span class="linenos">1001</span>        <span class="s1">&#39;Slsh&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
<span class="linenos">1002</span>        <span class="s1">&#39;Coln&#39;</span><span class="p">:</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
<span class="linenos">1003</span>        <span class="s1">&#39;SCln&#39;</span><span class="p">:</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span>
<span class="linenos">1004</span>        <span class="s1">&#39;-LT-&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
<span class="linenos">1005</span>        <span class="s1">&#39;Eqls&#39;</span><span class="p">:</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span>
<span class="linenos">1006</span>        <span class="s1">&#39;-GT-&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
<span class="linenos">1007</span>        <span class="s1">&#39;Ques&#39;</span><span class="p">:</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
<span class="linenos">1008</span>        <span class="s1">&#39;-AT-&#39;</span><span class="p">:</span> <span class="s1">&#39;@&#39;</span><span class="p">,</span>
<span class="linenos">1009</span>        <span class="s1">&#39;LSqB&#39;</span><span class="p">:</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span>
<span class="linenos">1010</span>        <span class="s1">&#39;RSqB&#39;</span><span class="p">:</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
<span class="linenos">1011</span>        <span class="s1">&#39;Bash&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="linenos">1012</span>        <span class="s1">&#39;Xor-&#39;</span><span class="p">:</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span>
<span class="linenos">1013</span>        <span class="s1">&#39;Unds&#39;</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span>
<span class="linenos">1014</span>        <span class="s1">&#39;BQuo&#39;</span><span class="p">:</span> <span class="s1">&#39;`&#39;</span><span class="p">,</span>
<span class="linenos">1015</span>        <span class="s1">&#39;LBra&#39;</span><span class="p">:</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span>
<span class="linenos">1016</span>        <span class="s1">&#39;Pipe&#39;</span><span class="p">:</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
<span class="linenos">1017</span>        <span class="s1">&#39;RBra&#39;</span><span class="p">:</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span>
<span class="linenos">1018</span>        <span class="s1">&#39;Tild&#39;</span><span class="p">:</span> <span class="s1">&#39;~&#39;</span><span class="p">,</span>
<span class="linenos">1019</span>    <span class="p">}</span>
<span class="linenos">1020</span><span class="p">)</span>
<span class="linenos">1021</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span><span class="n">MUNGE_TABLE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">FrozenDict</span><span class="p">({</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">UNMUNGE_TABLE</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<span class="linenos">1024</span>
<span class="linenos">1025</span>
<div class="viewcode-block" id="munge">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.munge">[docs]</a>
<span class="linenos">1026</span><span class="k">def</span> <span class="nf">munge</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1027</span>    <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="linenos">1028</span>    <span class="n">quot</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1029</span>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
<span class="linenos">1030</span>        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">MUNGE_TABLE</span><span class="p">:</span>
<span class="linenos">1031</span>            <span class="n">symbol</span> <span class="o">+=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">quot</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="linenos">1032</span>            <span class="n">symbol</span> <span class="o">+=</span> <span class="n">MUNGE_TABLE</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
<span class="linenos">1033</span>            <span class="n">quot</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1034</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1035</span>            <span class="n">symbol</span> <span class="o">+=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">if</span> <span class="n">quot</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="linenos">1036</span>            <span class="n">symbol</span> <span class="o">+=</span> <span class="n">c</span>
<span class="linenos">1037</span>            <span class="n">quot</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1038</span>    <span class="n">symbol</span> <span class="o">+=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">if</span> <span class="n">quot</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="linenos">1039</span>    <span class="k">return</span> <span class="n">symbol</span></div>

<span class="linenos">1040</span>
<span class="linenos">1041</span>
<div class="viewcode-block" id="unmunge">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.unmunge">[docs]</a>
<span class="linenos">1042</span><span class="k">def</span> <span class="nf">unmunge</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1043</span>    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unmunged</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span></div>

<span class="linenos">1044</span>
<span class="linenos">1045</span>
<div class="viewcode-block" id="unmunged">
<a class="viewcode-back" href="../../api/pyk.konvert.html#pyk.konvert.unmunged">[docs]</a>
<span class="linenos">1046</span><span class="k">def</span> <span class="nf">unmunged</span><span class="p">(</span><span class="n">it</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos">1047</span>    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<span class="linenos">1048</span>
<span class="linenos">1049</span>    <span class="n">startquote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1050</span>    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1051</span>    <span class="n">endquote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1052</span>    <span class="n">buff</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1053</span>    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># len(buff)</span>
<span class="linenos">1054</span>
<span class="linenos">1055</span>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
<span class="linenos">1056</span>        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
<span class="linenos">1057</span>            <span class="k">if</span> <span class="n">startquote</span><span class="p">:</span>
<span class="linenos">1058</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty quoted section&#39;</span><span class="p">)</span>
<span class="linenos">1059</span>            <span class="k">elif</span> <span class="n">quote</span><span class="p">:</span>
<span class="linenos">1060</span>                <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1061</span>                    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1062</span>                    <span class="n">endquote</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1063</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1064</span>                    <span class="n">fragment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="linenos">1065</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected end of symbol: </span><span class="si">{</span><span class="n">fragment</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1066</span>            <span class="k">elif</span> <span class="n">endquote</span><span class="p">:</span>
<span class="linenos">1067</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quoted sections next to each other&#39;</span><span class="p">)</span>
<span class="linenos">1068</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1069</span>                <span class="n">quote</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1070</span>                <span class="n">startquote</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1071</span>
<span class="linenos">1072</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1073</span>            <span class="n">startquote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1074</span>            <span class="n">endquote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1075</span>            <span class="k">if</span> <span class="n">quote</span><span class="p">:</span>
<span class="linenos">1076</span>                <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">1077</span>                    <span class="n">buff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">1078</span>                    <span class="n">munged</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="linenos">1079</span>                    <span class="n">buff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1080</span>                    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1081</span>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">munged</span> <span class="ow">in</span> <span class="n">UNMUNGE_TABLE</span><span class="p">:</span>
<span class="linenos">1082</span>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown encoding &quot;</span><span class="si">{</span><span class="n">munged</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<span class="linenos">1083</span>                    <span class="k">yield</span> <span class="n">UNMUNGE_TABLE</span><span class="p">[</span><span class="n">munged</span><span class="p">]</span>
<span class="linenos">1084</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1085</span>                    <span class="n">buff</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
<span class="linenos">1086</span>                    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">1087</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1088</span>                <span class="k">yield</span> <span class="n">c</span>
<span class="linenos">1089</span>
<span class="linenos">1090</span>    <span class="k">if</span> <span class="n">quote</span><span class="p">:</span>
<span class="linenos">1091</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unterminated quoted section&#39;</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyk</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">pyk</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Runtime Verification, Inc.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>